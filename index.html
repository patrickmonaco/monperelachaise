<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cimeti√®re du P√®re Lachaise - v0.1</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#1d4ed8" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="max-w-7xl mx-auto py-10 px-4">
  <h1 class="text-3xl font-bold mb-8 text-center">üîç Cimeti√®re du P√®re Lachaise</h1>

  <div class="grid grid-cols-1 md:grid-cols-[280px_1fr] gap-8">

    <!-- === FILTRES === -->
    <aside class="bg-white p-5 rounded-2xl shadow space-y-6 h-fit md:sticky md:top-6">
      <div>
        <label class="font-semibold text-sm text-gray-600">Recherche texte</label>
        <input id="search-text" type="text" placeholder="Nom ou mot-cl√©..."
               class="w-full mt-1 border border-gray-300 rounded-lg p-2" disabled />
      </div>

      <div>
        <label class="font-semibold text-sm text-gray-600 block mb-1">Si√®cle</label>
        <select id="filter-century" class="w-full border border-gray-300 rounded-lg p-2" disabled>
          <option value="">Tous</option>
        </select>
      </div>

      <div>
        <span class="font-semibold text-sm text-gray-600 block mb-1">Cat√©gories</span>
        <div id="category-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-2 text-sm text-gray-700">
          <p class="text-gray-400 text-sm">Chargement...</p>
        </div>
      </div>

      <div class="border-t pt-3 text-sm text-gray-500 flex justify-between items-center">
        <span id="result-count">0 r√©sultat</span>
        <button id="refresh-btn" class="text-blue-600 hover:underline text-xs">üîÑ Actualiser</button>
      </div>
    </aside>

    <!-- === R√âSULTATS === -->
    <main>
      <div id="results" class="space-y-4 text-gray-600">
        <p class="text-center text-gray-400">Chargement des donn√©es...</p>
      </div>
    </main>
  </div>
</div>

<!-- === MODALE WIKIDATA === -->
<div id="wikidata-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white w-[90%] md:w-[70%] lg:w-[60%] h-[80%] rounded-2xl overflow-hidden shadow-2xl flex flex-col">
    <div class="flex justify-between items-center bg-blue-600 text-white px-4 py-2">
      <h3 id="wikidata-title" class="font-semibold text-lg">Wikidata</h3>
      <button id="wikidata-close" class="text-white text-2xl leading-none">&times;</button>
    </div>
    <iframe id="wikidata-frame" src="" class="flex-1 w-full border-0"></iframe>
  </div>
</div>

<script>
const DATA_URL = "https://patrickmonaco.github.io/monperelachaise/data.json"; // üîó ton fichier JSON
const CACHE_KEY = "faceted_data_cache_v5";
const CACHE_TTL = 1000 * 60 * 60 * 24; // 24h

let data = [];
let fuse = null;

// === S√©lecteurs DOM ===
const resultsDiv = document.getElementById("results");
const resultCount = document.getElementById("result-count");
const categoryContainer = document.getElementById("category-checkboxes");
const centurySelect = document.getElementById("filter-century");
const searchInput = document.getElementById("search-text");
const refreshBtn = document.getElementById("refresh-btn");

// === Fonction d'affichage ===
function renderResults(items) {
  resultsDiv.innerHTML = "";
  resultCount.textContent = `${items.length} r√©sultat${items.length > 1 ? "s" : ""}`;
  if (!items.length) {
    resultsDiv.innerHTML = `<p class="text-center text-gray-500">Aucun r√©sultat</p>`;
    return;
  }

  // üß© Tri alphanum√©rique sur "tri"
  items.sort((a, b) => {
    const ta = (a.tri || "").toString().toLowerCase();
    const tb = (b.tri || "").toString().toLowerCase();
    return ta.localeCompare(tb, 'fr', { numeric: true });
  });

  for (const item of items) {
    resultsDiv.innerHTML += `
      <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow transition">
        <div class="flex justify-between items-center mb-1">
          <h2 class="font-semibold text-lg text-blue-700 cursor-pointer hover:underline" 
              onclick="openInGoogleMaps('${item.lat}', '${item.long}')">
            ${item.nom}
          </h2>
          <div class="flex items-center gap-2">
            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${item.siecle || "-"}</span>
            ${item.wikidata ? `
              <button title="Voir sur Wikimedia" onclick="openWikiInfo('${item.wikidata}', '${item.nom}')"
                class="text-gray-500 hover:text-blue-600 transition text-xl">
                ‚ÑπÔ∏è
              </button>` : ""}
          </div>
        </div>
        <p class="text-sm text-gray-500">${item.categorie || "‚Äî"}</p>
        <p class="text-gray-700 mt-1">${item.description || ""}</p>
      </div>`;
  }
}

// === Navigation Google Maps ===
function openInGoogleMaps(lat, long) {
  if (!lat || !long) return;
  const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${long}&travelmode=walking&dir_action=navigate`;
  window.open(url, "_blank");
}

// === Affichage modale Wikidata ===
async function openWikiInfo(qid, name) {
  const modal = document.getElementById("wikidata-modal");
  const frame = document.getElementById("wikidata-frame");
  const title = document.getElementById("wikidata-title");

  title.textContent = name || "Informations";
  modal.classList.remove("hidden");
  modal.classList.add("flex");

  const wikipediaUrl = await getWikipediaFromWikidata(qid);
  frame.src = wikipediaUrl || `https://www.wikidata.org/wiki/${qid}`;
}

document.getElementById("wikidata-close").addEventListener("click", () => {
  const modal = document.getElementById("wikidata-modal");
  const frame = document.getElementById("wikidata-frame");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
  frame.src = "";
});
document.getElementById("wikidata-modal").addEventListener("click", (e) => {
  if (e.target.id === "wikidata-modal") {
    document.getElementById("wikidata-close").click();
  }
});

// === Application des filtres ===
function applyFilters() {
  const searchText = searchInput.value.trim().toLowerCase();
  const selectedCentury = centurySelect.value;
  const selectedCategories = [...categoryContainer.querySelectorAll("input[type=checkbox]:checked")].map(cb => cb.value);

  let filtered = data;
  if (searchText) filtered = fuse.search(searchText).map(r => r.item);
  filtered = filtered.filter(item =>
    (!selectedCentury || item.siecle === selectedCentury) &&
    (!selectedCategories.length || selectedCategories.includes(item.categorie))
  );
  renderResults(filtered);
}

// === Initialisation des filtres ===
function setupFilters() {
  //const categories = [...new Set(data.map(d => d.categorie))].filter(Boolean);
  const categories = [...new Set(data.map(item => item.categorie))].sort((a, b) =>
    a.localeCompare(b, 'fr', { sensitivity: 'base' })
  );
  categoryContainer.innerHTML = `
  <div class="grid grid-cols-2 gap-2 text-lg leading-snug">
    ${categories.map(cat => `
      <label class="flex items-center space-x-2 cursor-pointer">
        <input type="checkbox" value="${cat}" class="w-4 h-4 accent-blue-600">
        <span class="truncate">${cat}</span>
      </label>
    `).join('')}
  </div>
`;


  const centuries = [...new Set(data.map(d => d.siecle))].filter(Boolean).sort();
  centurySelect.innerHTML = '<option value="">Tous</option>' +
    centuries.map(c => `<option value="${c}">${c.toUpperCase()}</option>`).join("");

  searchInput.disabled = false;
  centurySelect.disabled = false;

  searchInput.addEventListener("input", applyFilters);
  centurySelect.addEventListener("change", applyFilters);
  categoryContainer.querySelectorAll("input[type=checkbox]").forEach(cb => cb.addEventListener("change", applyFilters));

  applyFilters();
}

// === Gestion du cache local ===
function saveToCache(json) {
  localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: json }));
}
function loadFromCache() {
  const record = localStorage.getItem(CACHE_KEY);
  if (!record) return null;
  const parsed = JSON.parse(record);
  return (Date.now() - parsed.timestamp < CACHE_TTL) ? parsed.data : null;
}
// === Resolution adresse wikipedia ===
async function getWikipediaFromWikidata(qid, lang = "fr") {
  try {
    const url = `https://www.wikidata.org/wiki/Special:EntityData/${qid}.json`;
    const response = await fetch(url);
    if (!response.ok) throw new Error("Erreur Wikidata");
    const data = await response.json();
    const entity = data.entities[qid];
    const sitelink = entity?.sitelinks?.[`${lang}wiki`]?.title;
    if (!sitelink) return null;
    return `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(sitelink)}`;
  } catch (e) {
    console.error("Erreur Wikidata ‚Üí Wikipedia:", e);
    return null;
  }
}


  
// === Chargement des donn√©es ===
async function loadData(forceRefresh = false) {
  try {
    if (!forceRefresh) {
      const cached = loadFromCache();
      if (cached) {
        data = cached;
        //fuse = new Fuse(data, { keys: ["nom", "description", "categorie"], threshold: 0.15 });
        fuse = new Fuse(data, {
              keys: [
                { name: "nom", weight: 0.8 },
                { name: "description", weight: 0.15 },
                { name: "categorie", weight: 0.05 }
              ],
              threshold: 0.2,
              distance: 50
            });
        setupFilters();
        return;
      }
    }
    const response = await fetch(DATA_URL, { cache: "no-store" });
    if (!response.ok) throw new Error("Erreur de chargement du fichier JSON.");
    const json = await response.json();

    data = json.sort((a, b) => {
      const ta = (a.tri || "").toString().toLowerCase();
      const tb = (b.tri || "").toString().toLowerCase();
      return ta.localeCompare(tb, 'fr', { numeric: true });
    });
    fuse = new Fuse(data, { keys: ["nom", "description", "categorie"], threshold: 0.4 });
    saveToCache(json);
    setupFilters();
  } catch (err) {
    resultsDiv.innerHTML = `<p class="text-center text-red-500">${err.message}</p>`;
  }
}

refreshBtn.addEventListener("click", () => {
  localStorage.removeItem(CACHE_KEY);
  loadData(true);
});

loadData();
</script>
</body>
</html>









