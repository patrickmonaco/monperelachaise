<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Mon P√®re Lachaise</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#1d4ed8" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="max-w-7xl mx-auto py-10 px-4">
 <h1 class="text-3xl font-bold mb-8 text-center flex items-center justify-center gap-3">
  <img src="icons/icone_pl.png" alt="Ic√¥ne gauche" class="w-12 h-12 transition-transform duration-700 hover:rotate-12 hover:scale-110 animate-pulse-slow">
  Mon P√®re Lachaise
  <img src="icons/icone_pl.png" alt="Ic√¥ne droite" class="w-12 h-12 transition-transform duration-700 hover:-rotate-12 hover:scale-110 animate-pulse-slow">
</h1>

<style>
@keyframes pulseSlow {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
}
.animate-pulse-slow { animation: pulseSlow 6s ease-in-out infinite; }

/* R√©duction hauteur lignes et mise en avant du nom */
.result-card {
  padding: 0.5rem 0.9rem;
  line-height: 1.2rem;
}
.result-card h2 {
  font-size: 1.35rem;
  font-weight: 400;
  color: #1d4ed8;
}
.result-card p {
  font-size: 0.85rem;
  color: #4b5563;
}
.badge {
  font-size: 0.7rem;
  background: #f3f4f6;
  color: #6b7280;
  padding: 0.15rem 0.4rem;
  border-radius: 0.4rem;
}
.info-btn {
  font-size: 1rem;
  color: #6b7280;
  transition: color 0.2s;
}
.info-btn:hover {
  color: #1d4ed8;
}
</style>

<div class="grid grid-cols-1 md:grid-cols-[320px_1fr] gap-8">
  <!-- FILTRES -->
  <aside class="bg-white p-5 rounded-2xl shadow space-y-6 h-fit md:sticky md:top-6">
    <div>
      <label class="font-semibold text-sm text-gray-600">Recherche texte</label>
      <div class="relative mt-1">
        <input id="searchInput" type="text" placeholder="Nom ou mot-cl√©..." class="w-full border border-gray-300 rounded-lg p-2 pr-10" disabled />
        <button id="micButton" title="Recherche vocale" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-blue-600 text-xl" aria-label="Micro">üé§</button>
      </div>
      <div id="micStatus" class="text-xs text-gray-500 mt-1 h-4"></div>
    </div>

    <div>
      <label class="font-semibold text-sm text-gray-600 block mb-1">Si√®cle</label>
      <select id="filter-century" class="w-full border border-gray-300 rounded-lg p-2" disabled>
        <option value="">Tous</option>
      </select>
    </div>

    <div>
      <span class="font-semibold text-sm text-gray-600 block mb-2">Cat√©gories</span>
      <div id="category-checkboxes" class="grid grid-cols-2 gap-x-6 gap-y-2 text-base text-gray-700 leading-snug">
        <p class="text-gray-400 text-sm">Chargement...</p>
      </div>
    </div>

    <div class="border-t pt-3 text-sm text-gray-500 flex justify-between items-center">
      <span id="result-count">0 r√©sultat</span>
      <button id="refresh-btn" class="text-blue-600 hover:underline text-xs">üîÑ Actualiser</button>
    </div>
  </aside>

  <!-- R√âSULTATS -->
  <main>
    <div id="results" class="space-y-2 text-gray-600">
      <p class="text-center text-gray-400 animate-pulse">‚è≥ Chargement...</p>
    </div>
  </main>
</div>
</div>

<!-- MODALE WIKI -->
<div id="wikidata-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white w-[95%] md:w-[75%] lg:w-[60%] h-[80%] rounded-2xl overflow-hidden shadow-2xl flex flex-col">
    <div class="flex justify-between items-center bg-blue-600 text-white px-4 py-2">
      <h3 id="wikidata-title" class="font-semibold text-lg">Informations</h3>
      <button id="wikidata-close" class="text-white text-2xl leading-none" aria-label="Fermer">√ó</button>
    </div>
    <iframe id="wikidata-frame" src="" class="flex-1 w-full border-0" referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<div id="updateBanner" class="hidden fixed bottom-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-xl shadow-lg cursor-pointer z-50">
  üîÑ Nouvelle version disponible ‚Äî cliquez pour recharger
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const DATA_URL = "https://patrickmonaco.github.io/monperelachaise/data.json";
  const CACHE_KEY = "faceted_data_cache_v10";
  const CACHE_TTL = 1000 * 60 * 60 * 24;

  let data = [];
  let fuse = null;

  const resultsDiv = document.getElementById("results");
  const resultCount = document.getElementById("result-count");
  const categoryContainer = document.getElementById("category-checkboxes");
  const centurySelect = document.getElementById("filter-century");
  const searchInput = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refresh-btn");

  function renderResults(items) {
    resultsDiv.innerHTML = "";
    resultCount.textContent = `${items.length} r√©sultat${items.length > 1 ? "s" : ""}`;
    if (!items.length) {
      resultsDiv.innerHTML = `<p class="text-center text-gray-500">Aucun r√©sultat</p>`;
      return;
    }

    items.sort((a,b)=>(a.tri||"").localeCompare(b.tri||"","fr",{numeric:true}));

    for (const item of items) {
      resultsDiv.innerHTML += `
        <div class="result-card bg-white rounded-xl shadow-sm hover:shadow transition">
          <div class="flex justify-between items-center mb-1">
            <h2 class="cursor-pointer hover:underline" onclick="openInGoogleMaps('${item.lat}', '${item.long}')">
              ${item.nom}
            </h2>
            <div class="flex items-center gap-2">
              <span class="badge">${item.siecle || "-"}</span>
              ${item.wikidata ? `<button title="Voir la fiche" onclick="openWikiInfo('${item.wikidata}', '${item.nom.replace(/'/g,"&#39;")}')" class="info-btn">‚ÑπÔ∏è</button>` : ""}
            </div>
          </div>
          <p>${item.categorie || "‚Äî"}</p>
        </div>`;
    }
  }

  window.openInGoogleMaps = function(lat,long){
    if(!lat||!long)return;
    const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const url=isMobile&&/Android/i.test(navigator.userAgent)?
      `google.navigation:q=${lat},${long}&mode=w`:
      `https://www.google.com/maps/dir/?api=1&destination=${lat},${long}&travelmode=walking`;
    window.open(url,"_blank");
  };

  async function getWikipediaFromWikidata(qid, lang = "fr") {
    try {
      const resp = await fetch(`https://www.wikidata.org/wiki/Special:EntityData/${qid}.json`);
      const json = await resp.json();
      const entity = json.entities?.[qid];
      const frLink = entity?.sitelinks?.[`${lang}wiki`];
      const enLink = entity?.sitelinks?.["enwiki"];
      if (frLink && frLink.title)
        return `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(frLink.title)}`;
      else if (enLink && enLink.title)
        return `https://en.wikipedia.org/wiki/${encodeURIComponent(enLink.title)}`;
      else return null;
    } catch {
      return null;
    }
  }

  window.openWikiInfo=async(qid,name)=>{
    const modal=document.getElementById("wikidata-modal");
    const frame=document.getElementById("wikidata-frame");
    const title=document.getElementById("wikidata-title");
    title.textContent=name||"Informations";
    modal.classList.remove("hidden");modal.classList.add("flex");
    frame.src="";
    const url=await getWikipediaFromWikidata(qid);
    frame.src=url||`https://www.wikidata.org/wiki/${qid}`;
  };
  document.getElementById("wikidata-close").onclick=()=>{const m=document.getElementById("wikidata-modal");const f=document.getElementById("wikidata-frame");m.classList.add("hidden");m.classList.remove("flex");f.src="";};
  document.getElementById("wikidata-modal").onclick=e=>{if(e.target.id==="wikidata-modal")document.getElementById("wikidata-close").click();};

  function applyFilters(){
    const txt=searchInput.value.trim().toLowerCase();
    const century=centurySelect.value;
    const cats=[...categoryContainer.querySelectorAll("input:checked")].map(c=>c.value);
    let filtered=data;
    if(txt){
      let exact=data.filter(it=>(it.nom||"").toLowerCase().includes(txt));
      if(!exact.length)exact=fuse.search(txt).map(r=>r.item);
      filtered=exact;
    }
    filtered=filtered.filter(it=>(!century||it.siecle===century)&&(!cats.length||cats.includes(it.categorie)));
    renderResults(filtered);
  }

  function setupFilters(){
    const cats=[...new Set(data.map(d=>d.categorie))].filter(Boolean).sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
    categoryContainer.innerHTML=cats.map(c=>`<label class="flex items-center space-x-2"><input type="checkbox" value="${c}" class="w-4 h-4 accent-blue-600"><span>${c}</span></label>`).join("");
    const centuries=[...new Set(data.map(d=>d.siecle))].filter(Boolean).sort();
    centurySelect.innerHTML='<option value="">Tous</option>'+centuries.map(c=>`<option value="${c}">${c}</option>`).join("");
    searchInput.disabled=false;centurySelect.disabled=false;
    searchInput.oninput=applyFilters;centurySelect.onchange=applyFilters;
    categoryContainer.querySelectorAll("input").forEach(cb=>cb.onchange=applyFilters);
    applyFilters();
  }

  function saveToCache(j){localStorage.setItem(CACHE_KEY,JSON.stringify({timestamp:Date.now(),data:j}));}
  function loadFromCache(){const r=localStorage.getItem(CACHE_KEY);if(!r)return null;const p=JSON.parse(r);return(Date.now()-p.timestamp<CACHE_TTL)?p.data:null;}

  async function loadData(force=false){try{const cached=!force&&loadFromCache();if(cached){data=cached;initFuse();setupFilters();return;}const resp=await fetch(DATA_URL,{cache:"no-store"});const j=await resp.json();data=j;initFuse();saveToCache(j);setupFilters();}catch(e){resultsDiv.innerHTML=`<p class='text-center text-red-500'>${e.message}</p>`;}}

  function initFuse(){fuse=new Fuse(data,{keys:[{name:"nom",weight:.8},{name:"description",weight:.15},{name:"categorie",weight:.05}],threshold:.2,distance:50});}

  refreshBtn.onclick=()=>{localStorage.removeItem(CACHE_KEY);loadData(true);};
  loadData();
});
</script>
</body>
</html>

