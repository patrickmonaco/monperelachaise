<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Mon P√®re Lachaise</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#1d4ed8" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plugins : boussole & g√©olocalisation -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-compass/dist/leaflet-compass.css" />
<script src="https://unpkg.com/leaflet-compass/dist/leaflet-compass.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<style>
.map-label span {
  background: rgba(255, 255, 255, 0.85);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 6px;
  padding: 2px 6px;
  font-size: 13px;
  color: #1e3a8a;
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transform: translate(10px, -10px);
  display: none;
}

#image-modal {
  animation: fadeIn 0.25s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
#image-modal-caption {
  max-width: 90vw;
  line-height: 1.4;
}

#viewList, #viewMap {
  transition: opacity 0.4s ease, transform 0.3s ease;
}

.hidden {
  opacity: 0 !important;
  transform: translateY(10px);
  pointer-events: none;
}

@keyframes pulseSlow {
  0%,100%{transform:scale(1);opacity:1;}
  50%{transform:scale(1.05);opacity:0.9;}
}
.animate-pulse-slow{animation:pulseSlow 6s ease-in-out infinite;}
.tab-active{background-color:#2563eb;color:white;}
.fade-in {
  opacity: 0;
  transition: opacity 0.6s ease-in-out;
}
.fade-in.loaded {
  opacity: 1;
}
</style>
</head>

<body class="bg-gray-50 text-gray-800">
<div class="max-w-7xl mx-auto py-10 px-4">
  <h1 class="text-3xl font-bold mb-8 text-center flex items-center justify-center gap-3">
    <img src="icons/icone_pl.png" alt="Ic√¥ne gauche" class="w-12 h-12 animate-pulse-slow">
    Mon P√®re Lachaise 0.25
    <img src="icons/icone_pl.png" alt="Ic√¥ne droite" class="w-12 h-12 animate-pulse-slow">
  </h1>

  <div class="flex justify-center mb-6">
    <button id="tab-list" class="px-4 py-2 border rounded-l-lg tab-active">Liste</button>
    <button id="tab-map" class="px-3 py-1 rounded-lg text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">Carte</button>
  </div>

  <div id="view-list" class="grid grid-cols-1 md:grid-cols-[320px_1fr] gap-8">
    <aside class="bg-white p-5 rounded-2xl shadow space-y-6 h-fit md:sticky md:top-6">
      <div>
        <label class="font-semibold text-sm text-gray-600">Recherche texte</label>
        <div class="relative mt-1">
          <input id="searchInput" type="text" placeholder="Nom ou mot-cl√©..." class="w-full border border-gray-300 rounded-lg p-2 pr-16" disabled />
          <button id="clearButton" class="absolute right-9 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-500 text-xl hidden" title="Effacer">‚ùå</button>
          <button id="micButton" title="Recherche vocale" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-blue-600 text-xl" aria-label="Micro">üé§</button>
        </div>
        <div id="micStatus" class="text-xs text-gray-500 mt-1 h-4"></div>
      </div>

      <div>
        <label class="font-semibold text-sm text-gray-600 block mb-1">Si√®cle</label>
        <select id="filter-century" class="w-full border border-gray-300 rounded-lg p-2" disabled>
          <option value="">Tous</option>
        </select>
      </div>

      <div>
        <span class="font-semibold text-sm text-gray-600 block mb-2">Cat√©gories</span>
        <div id="category-checkboxes" class="grid grid-cols-2 gap-x-4 gap-y-2 text-base text-gray-700 leading-snug">
          <p class="text-gray-400 text-sm">Chargement...</p>
        </div>
      </div>

      <div class="border-t pt-3 text-sm text-gray-500 flex justify-between items-center">
        <span id="result-count">0 r√©sultat</span>
        <button id="refresh-btn" class="text-blue-600 hover:underline text-xs">üîÑ Actualiser</button>
      </div>
    </aside>

    <main>
      <div id="results" class="space-y-2 text-gray-600">
        <p class="text-center text-gray-400 animate-pulse">‚è≥ Chargement...</p>
      </div>
    </main>
  </div>

  <div id="view-map" class="hidden h-[75vh] rounded-2xl overflow-hidden shadow">
    <div id="map" class="w-full h-full"></div>
  </div>
</div>

<!-- Modales et banni√®res (inchang√©es) -->
<div id="wikidata-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white w-[95%] md:w-[75%] lg:w-[60%] h-[80%] rounded-2xl overflow-hidden shadow-2xl flex flex-col">
    <div class="flex justify-between items-center bg-blue-600 text-white px-4 py-2">
      <h3 id="wikidata-title" class="font-semibold text-lg">Informations</h3>
      <button id="wikidata-close" class="text-white text-2xl leading-none" aria-label="Fermer">√ó</button>
    </div>
    <iframe id="wikidata-frame" src="" class="flex-1 w-full border-0" referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<div id="updateBanner" class="hidden fixed bottom-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-xl shadow-lg cursor-pointer z-50">
  üîÑ Nouvelle version disponible ‚Äî cliquez pour recharger
</div>

<div id="image-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4">
  <div class="flex flex-col items-center">
    <img id="image-modal-content" src="" alt="Aper√ßu" class="max-h-[85vh] max-w-[90vw] rounded-2xl shadow-2xl border-4 border-white cursor-pointer transition-transform duration-300 scale-100 hover:scale-105" />
    <p id="image-modal-caption" class="text-white text-center mt-3 text-lg font-medium drop-shadow-lg"></p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const DATA_URL = "https://patrickmonaco.github.io/monperelachaise/data.json";
  const CACHE_KEY = "faceted_data_cache_v12";
  const CACHE_TTL = 1000 * 60 * 60 * 24;
  let data = [], fuse = null, map = null, markers = [];

  const resultsDiv = document.getElementById("results");
  const resultCount = document.getElementById("result-count");
  const categoryContainer = document.getElementById("category-checkboxes");
  const centurySelect = document.getElementById("filter-century");
  const searchInput = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refresh-btn");
  const clearBtn = document.getElementById("clearButton");
  const micButton = document.getElementById("micButton");
  const micStatus = document.getElementById("micStatus");
  const updateBanner = document.getElementById("updateBanner");
  const tabList = document.getElementById("tab-list");
  const tabMap = document.getElementById("tab-map");
  const viewList = document.getElementById("view-list");
  const viewMap = document.getElementById("view-map");

  // --- Navigation entre onglets ---
  tabList.onclick = () => {
    tabList.classList.add("tab-active");
    tabMap.classList.remove("tab-active");
    viewList.classList.remove("hidden");
    viewMap.classList.add("hidden");
  };

  tabMap.onclick = () => {
    tabMap.classList.add("tab-active");
    tabList.classList.remove("tab-active");
    viewList.classList.add("hidden");
    viewMap.classList.remove("hidden");

    if (!map) {
      initMap();
      map.on("zoomend", toggleLabels);
    }
  };

  function toggleLabels() {
    const zoom = map.getZoom();
    const showLabels = zoom >= 18;
    document.querySelectorAll(".map-label span").forEach(el => {
      el.style.display = showLabels ? "block" : "none";
    });
  }

  // --- Nouvelle initialisation de la carte avec boussole et g√©oloc ---
  function initMap() {
    map = L.map("map").setView([48.8606, 2.3934], 16);

    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors',
      maxZoom: 19
    }).addTo(map);

    // Ajout boussole Leaflet Compass
    const compass = new L.Control.Compass({
      autoActive: true,
      showDigit: true,
      position: 'topright'
    });
    map.addControl(compass);

    // Ajout bouton de g√©olocalisation
    L.control.locate({
      position: 'topleft',
      strings: { title: "Me localiser" },
      flyTo: true
    }).addTo(map);

    updateMapMarkers(data);
  }

  // --- Marqueurs, filtres, donn√©es, etc. (inchang√©s) ---
  function updateMapMarkers(items) {
    if (!map) return;
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    items.forEach(item => {
      if (item.lat && item.long) {
        const pic = item.pic
          ? `<img src="${item.pic}" loading="lazy" class="w-10 h-10 rounded-lg mr-3 object-cover fade-in cursor-zoom-in" onload="this.classList.add('loaded')" onclick="openImageModal('${item.pic.replace(/'/g, "\\'")}', '${item.nom.replace(/'/g, "\\'")}')" alt="Portrait de ${item.nom}">`
          : `<div class='w-10 h-10 mr-2 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400'>ü™¶</div>`;

        const popup = `<div class="flex items-center">${pic}<div><b>${item.nom}</b><br><button onclick="openNavigation('${item.lat}','${item.long}')" class="text-blue-600 underline mt-1">üö∂ Naviguer</button></div></div>`;

        const marker = L.marker([item.lat, item.long]).bindPopup(popup).addTo(map);
        markers.push(marker);

        const label = L.divIcon({ className: "map-label", html: `<span>${item.nom}</span>`, iconSize: null });
        const labelMarker = L.marker([item.lat, item.long], { icon: label }).addTo(map);
        labelMarker._isLabel = true;
        markers.push(labelMarker);
      }
    });

    toggleLabels();
  }

  // Le reste de ton code (filtres, modales, etc.) reste inchang√©...
  loadData();
});
</script>
</body>
</html>
